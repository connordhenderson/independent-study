-- query_00_63_08.sql
select 
  s_store_name,
  sum(ss_net_profit) 
from 
  store_sales,
  date_dim,
  store,
  (select 
     ca_zip 
   from 
     (SELECT 
        substr(ca_zip, 1, 5) ca_zip 
      FROM 
        customer_address 
      WHERE 
        substr(ca_zip, 1, 5) IN ( '57649', '22796', '17825', '85607', '62110', '81532', '27055', '50713', '29833', '46958', '34661', '58508', '11832', '20275', '43356', '83395', '39948', '55506', '68591', '38327', '50786', '98422', '67439', '99499', '92423', '14930', '43553', '77485', '28899', '10503', '78468', '87812', '66187', '50022', '13531', '33575', '53535', '70050', '63979', '36147', '79941', '18035', '23850', '89231', '27161', '37024', '76475', '29791', '79227', '23944', '25782', '21164', '18529', '46584', '82552', '43176', '82382', '43942', '54990', '86944', '20372', '30356', '11893', '16379', '31609', '20014', '23453', '30161', '36785', '38472', '86678', '32272', '53661', '66272', '94156', '90235', '90510', '35191', '96637', '28879', '95594', '49051', '82691', '36561', '22584', '90933', '63777', '98794', '86910', '67462', '73986', '82813', '90118', '57660', '90928', '90404', '18360', '91662', '77861', '75122', '32192', '88288', '88318', '27773', '74281', '90224', '67588', '29643', '48535', '45315', '87241', '55739', '22316', '20346', '24886', '51328', '28353', '29853', '74498', '13367', '68038', '45498', '85269', '46091', '26241', '57574', '81540', '45773', '76693', '10840', '98776', '52300', '90940', '74333', '43901', '25107', '41541', '26065', '75553', '37047', '27983', '32750', '47628', '36892', '15301', '80052', '68316', '98190', '49713', '95725', '83631', '42914', '28364', '89876', '32259', '23765', '20070', '60833', '73880', '60504', '94619', '42162', '24912', '50781', '19457', '18992', '21909', '96464', '67581', '17850', '93575', '25655', '48810', '45085', '79251', '71990', '21141', '38815', '14220', '56839', '88165', '94825', '36735', '27489', '97362', '15835', '11028', '53212', '36908', '15844', '31218', '74846', '42152', '21604', '11544', '27474', '95974', '23338', '94117', '51024', '12279', '88598', '59462', '93007', '76283', '79347', '65213', '10255', '81056', '60449', '26640', '55860', '33648', '78956', '59063', '69690', '37962', '35891', '30024', '71758', '21302', '34411', '59671', '51225', '12027', '48632', '44292', '81897', '82990', '19837', '16086', '64053', '94194', '81476', '17370', '21222', '43030', '65194', '34682', '21671', '58602', '13297', '46601', '57134', '91617', '10407', '83216', '19296', '60791', '73166', '63085', '38200', '78518', '18314', '80690', '56551', '30470', '14280', '37912', '95880', '15878', '15341', '85934', '24329', '26801', '35277', '15489', '16660', '68561', '30532', '20462', '31283', '52301', '94819', '34026', '68694', '62532', '32884', '49959', '67530', '68117', '55374', '53200', '38110', '14370', '98548', '46171', '41671', '13019', '82539', '76487', '36392', '26915', '26541', '65085', '42093', '27299', '45781', '50733', '69723', '57753', '28340', '75796', '34453', '75835', '37138', '12844', '88970', '58765', '85601', '49089', '24289', '13493', '51108', '23355', '44432', '83256', '32985', '71037', '43050', '46834', '20425', '84757', '80167', '57702', '18970', '33108', '78505', '36112', '85430', '18225', '67984', '52171', '47617', '27484', '34610', '34685', '69092', '26501', '34577', '60004', '35088', '46299', '27559', '10986', '94838', '36846', '10796', '13742', '66032', '77697', '49407', '25779', '56120', '48956', '94551', '64490', '30137', '38575', '45017', '38547', '98175', '13693', '71642', '35996', '73480', '12181', '51967', '76690', '98228', '11691', '90353', '11726', '23923', '16057', '14294', '41037', '49586', '95258', '66666', '33008', '43611', '69295', '94843', '25948', '20939', '17754', '55869', '99316', '45554', '14958', '18534', '84020', '34151', '18112', '59791', '61173', '35706', '29173', '44100') 
      intersect 
      select 
        ca_zip 
      from 
        (SELECT 
           substr(ca_zip, 1, 5) ca_zip,
           count(*) cnt 
         FROM 
           customer_address,
           customer 
         WHERE 
           ca_address_sk = c_current_addr_sk and 
           c_preferred_cust_flag='Y' 
         group by 
           ca_zip 
         having 
           count(*) > 10
        )A1
     )A2
  ) V1 
where 
  ss_store_sk = s_store_sk and 
  ss_sold_date_sk = d_date_sk and 
  d_qoy = 2 and 
  d_year = 1999 and 
  (substr(s_zip, 1, 2) = substr(V1.ca_zip, 1, 2)) 
group by 
  s_store_name 
order by 
  s_store_name 
fetch first 100 rows only


;
